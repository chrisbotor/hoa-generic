name: HOA Portal Auto-Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ğŸ“¥ Pull latest code
        uses: actions/checkout@v4

      - name: ğŸ§¹ Pre-Build Cleanup
        run: |
          sudo /usr/bin/rm -rf target/ || true
          sudo /usr/bin/chown -R $USER:$USER .
          find ~/.m2/repository -name "*.lock" -delete || true

      - name: ğŸ”¨ Build Quarkus App
        run: mvn clean package -U -DskipTests

      - name: ğŸ›‘ Docker Name Conflict Cleanup
        run: |
          sudo /usr/bin/docker rm -f hoa-quarkus-app hoa-cloudflared hoa-web || true
          sudo /usr/bin/docker compose down --remove-orphans || true

- name: ğŸš€ Update Containers
        run: |
          # 1. Clear old containers to prevent name conflicts
          sudo /usr/bin/docker rm -f hoa-quarkus-app hoa-cloudflared hoa-web || true
          
          # 2. Create the .env file
          # Ensure 'cat' is indented at least 10 spaces from the start of the file
          cat <<EOF > $GITHUB_WORKSPACE/.env
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASS }}
          HASURA_URL=http://192.168.100.80:8080/v1/graphql
          HASURA_ADMIN_SECRET=${{ secrets.HASURA_SECRET }}
          EOF
          
          # 3. Deploy using explicit pathing for the self-hosted runner
          sudo /usr/bin/docker compose --project-directory $GITHUB_WORKSPACE --env-file $GITHUB_WORKSPACE/.env up -d --build --force-recreate
          
          # 4. Display the Quick Tunnel URL (optional but helpful)
          sleep 5
          sudo /usr/bin/docker logs hoa-cloudflared 2>&1 | grep "trycloudflare.com" || echo "Tunnel still starting..."
          
          # 5. Security cleanup
          sudo /usr/bin/rm $GITHUB_WORKSPACE/.env      
         
      - name: ğŸ“‰ Clean Up Storage
        run: sudo /usr/bin/docker image prune -f

      - name: ğŸ›¡ï¸ Post-Deployment Ownership Reset
        if: always()
        run: |
          sudo /usr/bin/chown -R $USER:$USER .
          sudo /usr/bin/rm -rf target/ || true
