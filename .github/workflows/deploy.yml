name: HOA Portal Auto-Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§¹ Pre-Build Cleanup
        run: |
          # Ensure target folder is cleared and permissions are set for the runner
          sudo rm -rf target/
          sudo chown -R $USER:$USER .

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: ğŸ”¨ Build Quarkus App
        run: ./mvnw clean package -U -DskipTests

      - name: ğŸ—‘ï¸ Name Conflict Cleanup
        run: |
          # Forcefully remove old containers to clear naming conflicts
          sudo /usr/bin/docker rm -f hoa-quarkus-app hoa-cloudflared hoa-web || true

      - name: ğŸš€ Update Containers
        run: |
          # 1. Create the .env file using the absolute workspace path
          # Indentation here is critical to avoid YAML parser errors
          cat <<EOF > $GITHUB_WORKSPACE/.env
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASS }}
          HASURA_URL=http://192.168.100.80:8080/v1/graphql
          HASURA_ADMIN_SECRET=${{ secrets.HASURA_SECRET }}
          EOF

          # 2. Deploy using the .env file and explicit pathing
          sudo /usr/bin/docker compose --project-directory $GITHUB_WORKSPACE --env-file $GITHUB_WORKSPACE/.env up -d --build --force-recreate

          # 3. Security cleanup: remove the temporary .env file
          sudo /usr/bin/rm $GITHUB_WORKSPACE/.env

      - name: ğŸ§¹ Storage Cleanup
        run: sudo /usr/bin/docker image prune -f

      - name: ğŸ›¡ï¸ Post-Deployment Permissions
        if: always()
        run: sudo chown -R $USER:$USER .
