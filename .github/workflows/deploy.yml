name: HOA Portal Auto-Deploy
on:
  push:
    branches: [ "main" ]
jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”¨ Build App
        run: ./mvnw clean package -DskipTests

      - name: ðŸš€ Update Containers
        run: |
          cat <<EOF > $GITHUB_WORKSPACE/.env
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASS }}
          HASURA_URL=http://192.168.100.80:8080/v1/graphql
          HASURA_ADMIN_SECRET=${{ secrets.HASURA_SECRET }}
          EOF
          sudo /usr/bin/docker rm -f hoa-quarkus-app hoa-cloudflared hoa-web || true
          sudo /usr/bin/docker compose --project-directory $GITHUB_WORKSPACE --env-file $GITHUB_WORKSPACE/.env up -d --build --force-recreate
          sudo /usr/bin/rm $GITHUB_WORKSPACE/.env
