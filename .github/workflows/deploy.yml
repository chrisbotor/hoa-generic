name: HOA Portal Auto-Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: üõ°Ô∏è Force Cleanup Permissions
        # Solves "EACCES: permission denied" by reclaiming ownership of target
        run: |
          if [ -d "target" ]; then
            sudo chown -R $USER:$USER target
            sudo rm -rf target
          fi

      - name: üìÇ Checkout Repository
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: üî® Build Quarkus App (Uber-Jar)
        run: ./mvnw clean package -U -DskipTests

      - name: üõ°Ô∏è Fix Build Permissions
        # Solves "Unable to access jarfile" by ensuring Docker can read the file
        run: sudo chmod -R 777 target/

      - name: üóëÔ∏è Clear Container Conflicts
        # Prevents "Conflict: Container name already in use"
        run: |
          sudo /usr/bin/docker rm -f hoa-quarkus-app hoa-cloudflared || true

      - name: üöÄ Update Containers & Sync Config
        run: |
          # 1. Create the .env with only the Database secrets
          echo "DB_USER=${{ secrets.DB_USER }}" > .env
          echo "DB_PASS=${{ secrets.DB_PASS }}" >> .env
          
          # 2. Identify the jar file (essential for the command below)
          JAR_NAME=$(ls target/*-runner.jar | xargs basename)

          # 3. Generate docker-compose.yml 
          # Note: We removed the Hasura environment lines here 
          # because you have them hardcoded in application.properties
          cat << EOF > docker-compose.yml
          services:
            hoa-app:
              image: eclipse-temurin:21-jre-jammy
              container_name: hoa-quarkus-app
              volumes:
                - ./target:/deployments:z
              working_dir: /deployments
              environment:
                - DB_USER=\${DB_USER}
                - DB_PASS=\${DB_PASS}
                # We removed HASURA and JWT_SECRET from here 
                # because they are now hardcoded in your files for reliability
              command: java -Djava.util.logging.manager=org.jboss.logmanager.LogManager -jar /deployments/$JAR_NAME
              ports:
                - "8081:8080"
              restart: always

            hoa-tunnel:
              image: cloudflare/cloudflared:latest
              container_name: hoa-cloudflared
              command: tunnel --url http://hoa-quarkus-app:8080
              restart: always
          EOF

          # 4. Deploy using fresh config
          sudo /usr/bin/docker compose up -d --build --force-recreate --remove-orphans
          
          # 5. Cleanup temporary storage
          rm .env
          sudo /usr/bin/docker image prune -f

      - name: üîó Get Quick Tunnel URL
        run: |
          echo "Waiting 20 seconds for Cloudflare URL..."
          sleep 20
          echo "------------------------------------------------"
          echo "ACCESS YOUR PORTAL AT THE LINK BELOW:"
          sudo /usr/bin/docker logs hoa-cloudflared 2>&1 | grep -o 'https://[-a-z0-9.]*trycloudflare.com' || echo "URL not found yet. Check logs manually."
          echo "------------------------------------------------"

      - name: üõ°Ô∏è Post-Deployment Ownership Reset
        if: always()
        run: sudo /usr/bin/chown -R $USER:$USER .
