name: HOA Portal Auto-Deploy
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v4
      - name: ðŸ§¹ Cleanup
        run: sudo /usr/bin/rm -rf target/ || true
      - name: â˜• Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: ðŸ”¨ Build
        run: ./mvnw clean package -DskipTests
      - name: ðŸš€ Update Containers
        run: |
          printf "DB_USER=${{ secrets.DB_USER }}\nDB_PASS=${{ secrets.DB_PASS }}\nHASURA_URL=http://192.168.100.80:8080/v1/graphql\nHASURA_ADMIN_SECRET=${{ secrets.HASURA_SECRET }}\n" > .env
          sudo /usr/bin/docker compose up -d --build --force-recreate
          rm .env
      - name: ðŸ”— Get URL
        run: |
          echo "Waiting for tunnel..."
          sleep 20
          sudo /usr/bin/docker logs hoa-cloudflared 2>&1 | grep "trycloudflare.com" || echo "Link not ready."
