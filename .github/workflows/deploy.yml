name: HOA Portal Auto-Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allows you to trigger a deploy manually from the GitHub UI

jobs:
  deploy:
    runs-on: self-hosted # Targets your Beelink SER5 Pro runner

    steps:
      - name: ðŸ“¥ Pull latest code
        uses: actions/checkout@v4

      - name: ðŸ§¹ Fix Maven Permissions & Locks
        # Uses the NOPASSWD permission we set in /etc/sudoers.d/cbotor-github-runner
        run: |
          find ~/.m2/repository -name "*.lock" -delete || true
          sudo chown -R $USER:$USER ~/.m2
          sudo chmod -R 755 ~/.m2

      - name: ðŸ”¨ Build Quarkus App
        # -U forces Maven to update and fix any corrupted dependencies automatically
        run: mvn clean package -U -DskipTests

      - name: ðŸš€ Update Containers
        # --force-recreate ensures you never see the "Container name in use" error
        # --remove-orphans keeps your Docker environment clean
        run: |
          sudo docker compose up -d --build --force-recreate --remove-orphans

      - name: ðŸ“‰ Clean Up Storage
        # Essential for your 500GB NVMe to prevent disk bloat
        run: sudo docker image prune -f
