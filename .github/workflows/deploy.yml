name: HOA Portal Auto-Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ðŸ“¥ Pull latest code
        uses: actions/checkout@v4

      - name: ðŸ§¹ Pre-Build Cleanup
        run: |
          sudo /usr/bin/rm -rf target/ || true
          sudo /usr/bin/chown -R $USER:$USER .
          find ~/.m2/repository -name "*.lock" -delete || true
          sudo /usr/bin/chown -R $USER:$USER ~/.m2

      - name: ðŸ”¨ Build Quarkus App
        run: mvn clean package -U -DskipTests

      - name: ðŸ›‘ Docker Name Conflict Cleanup
        run: |
          sudo /usr/bin/docker rm -f hoa-quarkus-app hoa-cloudflared hoa-web || true
          sudo /usr/bin/docker compose down --remove-orphans || true

      - name: ðŸš€ Update Containers & Verify Secrets
        env:
          DB_USER_VAL: ${{ secrets.DB_USER }}
          DB_PASS_VAL: ${{ secrets.DB_PASS }}
          CF_TOKEN_VAL: ${{ secrets.CLOUDFLARE_TOKEN }}
        run: |
          # 1. Length Verification (Check logs to see if these are > 0)
          echo "Checking Secret Availability..."
          echo "DB_USER length: ${#DB_USER_VAL}"
          echo "DB_PASS length: ${#DB_PASS_VAL}"
          echo "CLOUDFLARE_TOKEN length: ${#CF_TOKEN_VAL}"
          
          # 2. Force create .env file with root authority
          sudo /usr/bin/tee .env <<EOF
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASS }}
          CLOUDFLARE_TOKEN=${{ secrets.CLOUDFLARE_TOKEN }}
          EOF
          
          # 3. Deploy using explicit env-file and sudo preservation
          sudo -E /usr/bin/docker compose --env-file .env up -d --build --force-recreate
          
          # 4. Immediate Security Cleanup
          sudo /usr/bin/rm .env

      - name: ðŸ“‰ Clean Up Storage
        run: sudo /usr/bin/docker image prune -f

      - name: ðŸ›¡ï¸ Post-Deployment Ownership Reset
        if: always()
        run: |
          sudo /usr/bin/chown -R $USER:$USER .
          sudo /usr/bin/rm -rf target/ || true
