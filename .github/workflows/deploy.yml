name: HOA Portal Auto-Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ðŸ“¥ Pull latest code
        uses: actions/checkout@v4

      - name: ðŸ§¹ Fix Maven Permissions & Locks
        run: |
          find ~/.m2/repository -name "*.lock" -delete || true
          sudo /usr/bin/chown -R $USER:$USER ~/.m2
          sudo /usr/bin/chmod -R 755 ~/.m2

      - name: ðŸ”¨ Build Quarkus App
        run: mvn clean package -U -DskipTests

      - name: ðŸ›‘ Total Pre-Deployment Cleanup
        # This nukes the specific service names to ensure no naming collisions
        # We add "|| true" so it doesn't crash if they don't exist yet
        run: |
          sudo /usr/bin/docker rm -f hoa-quarkus-app || true
          sudo /usr/bin/docker rm -f hoa-cloudflared || true
          sudo /usr/bin/docker compose down --remove-orphans || true

      - name: ðŸš€ Update Containers
        run: |
          sudo /usr/bin/docker compose up -d --build --force-recreate

      - name: ðŸ“‰ Clean Up Storage
        run: sudo /usr/bin/docker image prune -f
