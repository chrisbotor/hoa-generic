name: HOA Portal Auto-Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ§¹ Pre-Build Cleanup & Permission Fix
        run: |
          # Remove old build files and ensure current user owns the folder
          sudo /usr/bin/rm -rf target/ || true
          sudo /usr/bin/chown -R $USER:$USER .

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ðŸ”¨ Build Quarkus App
        run: ./mvnw clean package -U -DskipTests

      - name: ðŸ›¡ï¸ Fix Build Permissions for Docker
        run: |
          # Grant full permissions to the build output so the container can read it
          sudo chmod -R 777 target/

      - name: ðŸ—‘ï¸ Clear Container Conflicts
        run: |
          # Force remove any existing containers with these names to avoid "Conflict" errors
          sudo /usr/bin/docker rm -f hoa-quarkus-app hoa-cloudflared || true

      - name: ðŸš€ Update Containers & Fix LogManager
        run: |
          # 1. Create temporary .env with JBoss LogManager fix
          printf "DB_USER=${{ secrets.DB_USER }}\nDB_PASS=${{ secrets.DB_PASS }}\nHASURA_URL=http://192.168.100.80:8080/v1/graphql\nHASURA_ADMIN_SECRET=${{ secrets.HASURA_SECRET }}\nJAVA_OPTS=-Djava.util.logging.manager=org.jboss.logmanager.LogManager\n" > .env
          
          # 2. Deploy and build (using --remove-orphans as an extra safety measure)
          sudo /usr/bin/docker compose up -d --build --force-recreate --remove-orphans
          
          # 3. Cleanup storage on Beelink
          rm .env
          sudo /usr/bin/docker image prune -f
          sudo rm -rf $GITHUB_WORKSPACE/target

      - name: ðŸ”— Get Quick Tunnel URL
        run: |
          echo "Waiting 20 seconds for Cloudflare..."
          sleep 20
          echo "------------------------------------------------"
          echo "ACCESS YOUR PORTAL AT THE LINK BELOW:"
          sudo /usr/bin/docker logs hoa-cloudflared 2>&1 | grep -o 'https://[-a-z0-9.]*trycloudflare.com' || echo "URL not found yet."
          echo "------------------------------------------------"
