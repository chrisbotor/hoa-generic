name: HOA Portal Auto-Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: üõ°Ô∏è Force Cleanup Permissions
        run: |
          if [ -d "target" ]; then
            sudo chown -R $USER:$USER target
            sudo rm -rf target
          fi

      - name: üìÇ Checkout Repository
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: üî® Build Quarkus App (Uber-Jar)
        run: |
          date
          ./mvnw clean package -U -DskipTests

      - name: üöÄ Update Containers & Sync Config
        run: |
          # 1. Create the .env for DB only
          echo "DB_USER=${{ secrets.DB_USER }}" > .env
          echo "DB_PASS=${{ secrets.DB_PASS }}" >> .env
          
          # 2. Create the properties file
          mkdir -p src/main/resources/
          cat << 'EOF' > src/main/resources/application.properties
          quarkus.http.root-path=/portal
          quarkus.http.cors.enabled=true
          quarkus.http.cors.origins=*
          
          # Database Configuration
          quarkus.datasource.db-kind=postgresql
          quarkus.datasource.jdbc.url=jdbc:postgresql://192.168.100.80:5432/hoa_db
          quarkus.datasource.username=${DB_USER}
          quarkus.datasource.password=${DB_PASS}

          # Logging
          quarkus.log.level=INFO
          quarkus.log.category."io.smallrye.jwt".level=TRACE
          quarkus.log.category."io.quarkus.security".level=DEBUG
          EOF

          # 3. Generate docker-compose.yml with CRITICAL JWT FIXES
          cat << 'EOF' > docker-compose.yml
          services:
            hoa-app:
              image: eclipse-temurin:21-jre-jammy
              container_name: hoa-quarkus-app
              volumes:
                - ./target:/deployments:z
                - ./src/main/resources/application.properties:/deployments/application.properties:z
              working_dir: /deployments
              environment:
                - DB_USER=${DB_USER}
                - DB_PASS=${DB_PASS}
                # FORCED JWT OVERRIDES: Base64 is safer for environment variables
                - SMALLRYE_JWT_VERIFY_KEY=QmVlbGlua1NlcjVQcm9IT0FLZXlTdGF0aWMyMDI2MjY=
                - SMALLRYE_JWT_VERIFY_KEY_FORMAT=BASE64
                - SMALLRYE_JWT_VERIFY_KEY_ALGORITHM=HS256
                - MP_JWT_VERIFY_ISSUER=https://hoa-portal.com
                - SMALLRYE_JWT_PATH_GROUPS=groups
              # Force config location to ensure volume mount is prioritized
              command: sh -c "java -Djava.util.logging.manager=org.jboss.logmanager.LogManager -Dquarkus.config.locations=/deployments/application.properties -jar /deployments/*-runner.jar"
              ports:
                - "8081:8080"
              restart: always

            hoa-tunnel:
              image: cloudflare/cloudflared:latest
              container_name: hoa-cloudflared
              command: tunnel --url http://hoa-app:8080
              restart: always
          EOF

          # 4. Nuclear Refresh
          sudo /usr/bin/docker compose down -v
          sudo /usr/bin/docker compose up -d --build --force-recreate --remove-orphans
          
          # 5. Cleanup
          rm -f .env
          sudo /usr/bin/docker image prune -f

      - name: üõ°Ô∏è Post-Deployment Ownership Reset
        if: always()
        run: sudo /usr/bin/chown -R $USER:$USER .