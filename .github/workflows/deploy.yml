name: HOA Portal Auto-Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ğŸ“¥ Pull latest code
        uses: actions/checkout@v4

      - name: ğŸ§¹ Pre-Build Cleanup
        # Wipe target and fix ownership in case a previous run crashed
        run: |
          sudo /usr/bin/rm -rf target/ || true
          sudo /usr/bin/chown -R $USER:$USER .
          find ~/.m2/repository -name "*.lock" -delete || true
          sudo /usr/bin/chown -R $USER:$USER ~/.m2

      - name: ğŸ”¨ Build Quarkus App
        # -U ensures a fresh download if anything was corrupted
        run: mvn clean package -U -DskipTests

      - name: ğŸ›‘ Docker Name Conflict Cleanup
        # Prevents "Container name in use" errors for all services
        run: |
          sudo /usr/bin/docker rm -f hoa-quarkus-app hoa-cloudflared hoa-web || true
          sudo /usr/bin/docker compose down --remove-orphans || true

      - name: ğŸš€ Update Containers
        # --force-recreate ensures a fresh start for the subdivision portal
        run: |
          sudo /usr/bin/docker compose up -d --build --force-recreate

      - name: ğŸ“‰ Clean Up Storage
        # Keeps your 500GB NVMe lean
        run: sudo /usr/bin/docker image prune -f

      - name: ğŸ›¡ï¸ Post-Deployment Ownership Reset
        # THE FIX: This runs even if the build fails. It resets ownership
        # so GitHub's built-in cleanup can delete files next time.
        if: always()
        run: |
          sudo /usr/bin/chown -R $USER:$USER .
          sudo /usr/bin/rm -rf target/ || true
