<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HOA Portal | Secure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-8">

    <div id="status-bar" class="max-w-4xl mx-auto mb-4 p-2 rounded flex items-center justify-between text-sm bg-gray-200">
        <div class="flex items-center">
            <i id="lock-icon" class="fas fa-lock-open mr-2 text-gray-500"></i>
            <span id="status-text">Not Authenticated</span>
        </div>
        <div id="user-info" class="font-mono font-bold text-blue-700"></div>
    </div>

    <div id="login-form" class="max-w-md mx-auto bg-white p-6 rounded shadow border-t-4 border-blue-500">
        <h2 class="text-xl font-bold mb-4">Resident Login</h2>
        <input type="text" id="email" placeholder="Email" class="w-full p-2 mb-2 border rounded">
        <input type="password" id="password" placeholder="Password" class="w-full p-2 mb-4 border rounded">
        <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded transition">Login</button>
    </div>

    <div id="dashboard" class="hidden max-w-4xl mx-auto bg-white p-6 rounded shadow">
        <div class="flex justify-between mb-4 border-b pb-2">
            <h1 class="text-2xl font-bold text-gray-800">Maintenance Requests</h1>
            <button onclick="logout()" class="bg-red-50 text-red-600 px-3 py-1 rounded border border-red-200 hover:bg-red-100">Logout</button>
        </div>
        <div id="ticket-list" class="space-y-3">
            <p class="text-gray-500 italic">Fetching secure data...</p>
        </div>
    </div>

    <script>
        const API = "http://192.168.100.81:8081/portal";

        window.onload = () => {
            const token = localStorage.getItem('token');
            if (token) {
                updateAuthUI(true);
                loadTickets();
            }
        };

        function updateAuthUI(isAuthenticated, email = "") {
            const icon = document.getElementById('lock-icon');
            const text = document.getElementById('status-text');
            const bar = document.getElementById('status-bar');
            const userDisplay = document.getElementById('user-info');

            if (isAuthenticated) {
                icon.className = "fas fa-lock text-green-600";
                text.innerText = "Secure Session Active";
                bar.classList.replace('bg-gray-200', 'bg-green-100');
                userDisplay.innerText = email || "User Verified";
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
            } else {
                icon.className = "fas fa-lock-open text-gray-500";
                text.innerText = "Not Authenticated";
                bar.classList.replace('bg-green-100', 'bg-gray-200');
                userDisplay.innerText = "";
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const res = await fetch(`${API}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, passwordHash: password })
                });

                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem('token', data.token);
                    updateAuthUI(true, email);
                    loadTickets();
                } else {
                    alert("Invalid Credentials");
                }
            } catch (e) {
                alert("Server Connection Failed");
            }
        }

        async function loadTickets() {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API}/tickets`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const tickets = await res.json();
                    document.getElementById('ticket-list').innerHTML = tickets.map(t => `
                        <div class="p-4 bg-white border border-gray-200 rounded shadow-sm hover:border-blue-300 transition">
                            <div class="flex justify-between items-start">
                                <span class="font-semibold text-gray-800">${t.title}</span>
                                <span class="px-2 py-1 text-xs rounded ${getStatusClass(t.status)}">${t.status}</span>
                            </div>
                        </div>
                    `).join('');
                } else if (res.status === 401) {
                    logout();
                }
            } catch (e) {
                console.error("Secure fetch failed");
            }
        }

        function getStatusClass(status) {
            if (status === 'Pending') return 'bg-yellow-100 text-yellow-700';
            if (status === 'Completed') return 'bg-green-100 text-green-700';
            return 'bg-gray-100 text-gray-700';
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HOA Portal | Secure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-8">

    <div id="status-bar" class="max-w-4xl mx-auto mb-4 p-2 rounded flex items-center justify-between text-sm bg-gray-200">
        <div class="flex items-center">
            <i id="lock-icon" class="fas fa-lock-open mr-2 text-gray-500"></i>
            <span id="status-text">Not Authenticated</span>
        </div>
        <div id="user-info" class="font-mono font-bold text-blue-700"></div>
    </div>

    <div id="login-form" class="max-w-md mx-auto bg-white p-6 rounded shadow border-t-4 border-blue-500">
        <h2 class="text-xl font-bold mb-4">Resident Login</h2>
        <input type="text" id="email" placeholder="Email" class="w-full p-2 mb-2 border rounded">
        <input type="password" id="password" placeholder="Password" class="w-full p-2 mb-4 border rounded">
        <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded transition">Login</button>
    </div>

    <div id="dashboard" class="hidden max-w-4xl mx-auto bg-white p-6 rounded shadow">
        <div class="flex justify-between mb-4 border-b pb-2">
            <h1 class="text-2xl font-bold text-gray-800">Maintenance Requests</h1>
            <button onclick="logout()" class="bg-red-50 text-red-600 px-3 py-1 rounded border border-red-200 hover:bg-red-100">Logout</button>
        </div>
        <div id="ticket-list" class="space-y-3">
            <p class="text-gray-500 italic">Fetching secure data...</p>
        </div>
    </div>

    <script>
        const API = "http://192.168.100.81:8081/portal";

        window.onload = () => {
            const token = localStorage.getItem('token');
            if (token) {
                updateAuthUI(true);
                loadTickets();
            }
        };

        function updateAuthUI(isAuthenticated, email = "") {
            const icon = document.getElementById('lock-icon');
            const text = document.getElementById('status-text');
            const bar = document.getElementById('status-bar');
            const userDisplay = document.getElementById('user-info');

            if (isAuthenticated) {
                icon.className = "fas fa-lock text-green-600";
                text.innerText = "Secure Session Active";
                bar.classList.replace('bg-gray-200', 'bg-green-100');
                userDisplay.innerText = email || "User Verified";
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
            } else {
                icon.className = "fas fa-lock-open text-gray-500";
                text.innerText = "Not Authenticated";
                bar.classList.replace('bg-green-100', 'bg-gray-200');
                userDisplay.innerText = "";
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const res = await fetch(`${API}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, passwordHash: password })
                });

                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem('token', data.token);
                    updateAuthUI(true, email);
                    loadTickets();
                } else {
                    alert("Invalid Credentials");
                }
            } catch (e) {
                alert("Server Connection Failed");
            }
        }

        async function loadTickets() {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API}/tickets`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const tickets = await res.json();
                    document.getElementById('ticket-list').innerHTML = tickets.map(t => `
                        <div class="p-4 bg-white border border-gray-200 rounded shadow-sm hover:border-blue-300 transition">
                            <div class="flex justify-between items-start">
                                <span class="font-semibold text-gray-800">${t.title}</span>
                                <span class="px-2 py-1 text-xs rounded ${getStatusClass(t.status)}">${t.status}</span>
                            </div>
                        </div>
                    `).join('');
                } else if (res.status === 401) {
                    logout();
                }
            } catch (e) {
                console.error("Secure fetch failed");
            }
        }

        function getStatusClass(status) {
            if (status === 'Pending') return 'bg-yellow-100 text-yellow-700';
            if (status === 'Completed') return 'bg-green-100 text-green-700';
            return 'bg-gray-100 text-gray-700';
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }
    </script>
</body>
</html>