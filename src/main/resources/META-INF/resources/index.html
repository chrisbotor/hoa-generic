<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HOA Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-10">

    <div id="login-form" class="max-w-md mx-auto bg-white p-8 rounded shadow">
        <h2 class="text-2xl mb-4 font-bold">Resident Login</h2>
        <input type="text" id="email" placeholder="Email" class="w-full p-2 mb-2 border">
        <input type="password" id="password" placeholder="Password" class="w-full p-2 mb-4 border">
        <button onclick="login()" class="w-full bg-blue-600 text-white p-2 rounded">Login</button>
    </div>

    <div id="dashboard" class="hidden max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold mb-6">Your Dashboard</h2>
        <div id="data-container" class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded shadow">
                <h3 class="font-bold border-b mb-2">My Tickets</h3>
                <div id="tickets">Loading...</div>
            </div>
            <div class="bg-white p-4 rounded shadow">
                <h3 class="font-bold border-b mb-2">My Property</h3>
                <div id="house">Loading...</div>
            </div>
        </div>
        <button onclick="logout()" class="mt-4 text-red-600 underline">Logout</button>
    </div>

    <script>
        const API = "http://192.168.100.81:8081/portal";

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const res = await fetch(`${API}/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, passwordHash: password })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                        showDashboard();
                    }
                } else {
                    alert("Login failed. Check Beelink logs.");
                }
            } catch (e) { console.error(e); }
        }

        async function showDashboard() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            const token = localStorage.getItem('token');
            const headers = { 'Authorization': `Bearer ${token}` };

            // Fetch Tickets
            const ticketRes = await fetch(`${API}/tickets`, { headers });
            if (ticketRes.ok) {
                const tickets = await ticketRes.json();
                document.getElementById('tickets').innerHTML = tickets.length ? 
                    tickets.map(t => `<p>â€¢ ${t.title} (${t.status})</p>`).join('') : "No tickets.";
            }

            // Fetch House
            const houseRes = await fetch(`${API}/houses`, { headers });
            if (houseRes.ok) {
                const houses = await houseRes.json();
                if (houses.length) {
                    document.getElementById('house').innerHTML = `<p>${houses[0].streetAddress}</p><p>Lot ${houses[0].lotNumber}</p>`;
                }
            }
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        // Auto-login if token exists
        if (localStorage.getItem('token')) showDashboard();
    </script>
</body>
</html>